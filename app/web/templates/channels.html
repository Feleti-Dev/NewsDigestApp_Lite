{% extends "base.html" %}

{% block title %}Каналы - News Digest App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-broadcast"></i> Управление каналами
        </h1>
    </div>
</div>

<!-- Статистика каналов -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Общая статистика каналов</h5>
                <button class="btn btn-sm btn-primary" onclick="loadChannels()">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
            </div>
            <div class="card-body">
                <div class="row" id="channels-summary">
                    <!-- Заполнится через JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Фильтры и поиск -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Фильтры</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Источник</label>
                        <select class="form-select" id="filter-source">
                            <option value="all">Все источники</option>
                            <option value="telegram">Telegram</option>
                            <option value="youtube">YouTube</option>
                            <option value="twitter">Twitter/X</option>
                            <option value="reddit">Reddit</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" id="filter-status">
                            <option value="all">Все</option>
                            <option value="active">Активные</option>
                            <option value="inactive">Неактивные</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Сортировка</label>
                        <select class="form-select" id="filter-sort">
                            <option value="news">По количеству новостей</option>
                            <option value="score">По средней оценке</option>
                            <option value="success">По успешности</option>
                            <option value="recent">По последней обработке</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadChannels()">
                            <i class="bi bi-filter"></i> Применить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Таблица каналов -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Список каналов</h5>
                <span class="badge bg-secondary" id="channels-count">0 каналов</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="channels-table">
                        <thead>
                            <tr>
                                <th>Источник</th>
                                <th>Канал</th>
                                <th>Новостей</th>
                                <th>Средняя оценка</th>
                                <th>Успешность</th>
                                <th>Последняя обработка</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Заполнится через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadChannels();
    // Обновление каждые 30 секунд
    setInterval(loadChannels, 30000);
});

function loadChannels() {
    $.get('/api/channels/list', function(data) {
        updateChannelsSummary(data);
        updateChannelsTable(data.channels || []);
    }).fail(function(xhr, status, error) {
        const errorMessage = NewsDigestApp.utils.getConnectionErrorMessage(xhr, status, error);
        console.error(errorMessage);
        NewsDigestApp.utils.showToast(errorMessage, 'error');

        // Показываем ошибку в UI
        $('#channels-summary').html(`
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="bi bi-wifi-off"></i> ${errorMessage}
                </div>
            </div>
        `);
        $('#channels-table tbody').html(`
            <tr>
                <td colspan="8" class="text-center text-danger">
                    <i class="bi bi-wifi-off"></i> ${errorMessage}
                </td>
            </tr>
        `);
    });
}

function updateChannelsSummary(data) {
    const total = data.total || 0;
    const active = data.active || 0;
    const inactive = total - active;
    
    const html = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">${total}</h3>
                    <p class="card-text">Всего каналов</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">${active}</h3>
                    <p class="card-text">Активных</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">${inactive}</h3>
                    <p class="card-text">Неактивных</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="card-title">${data.channels ? data.channels.reduce((sum, c) => sum + (c.news_collected || 0), 0) : 0}</h3>
                    <p class="card-text">Всего новостей</p>
                </div>
            </div>
        </div>
    `;
    
    $('#channels-summary').html(html);
}

function updateChannelsTable(channels) {
    // Применяем фильтры
    const sourceFilter = $('#filter-source').val();
    const statusFilter = $('#filter-status').val();
    const sortBy = $('#filter-sort').val();
    
    let filteredChannels = channels;
    
    // Фильтрация по источнику
    if (sourceFilter !== 'all') {
        filteredChannels = filteredChannels.filter(c => c.source === sourceFilter);
    }
    
    // Фильтрация по статусу
    if (statusFilter === 'active') {
        filteredChannels = filteredChannels.filter(c => c.is_active);
    } else if (statusFilter === 'inactive') {
        filteredChannels = filteredChannels.filter(c => !c.is_active);
    }
    
    // Сортировка
    filteredChannels.sort((a, b) => {
        switch(sortBy) {
            case 'news':
                return (b.news_collected || 0) - (a.news_collected || 0);
            case 'score':
                return (b.avg_interest_score || 0) - (a.avg_interest_score || 0);
            case 'success':
                const aRate = a.success_count / (a.success_count + a.failure_count) || 0;
                const bRate = b.success_count / (b.success_count + b.failure_count) || 0;
                return bRate - aRate;
            case 'recent':
                const aTime = a.last_processed ? new Date(a.last_processed).getTime() : 0;
                const bTime = b.last_processed ? new Date(b.last_processed).getTime() : 0;
                return bTime - aTime;
            default:
                return 0;
        }
    });
    
    // Обновление счетчика
    $('#channels-count').text(`${filteredChannels.length} каналов`);
    
    // Обновление таблицы
    let html = '';
    if (filteredChannels.length > 0) {
        filteredChannels.forEach(channel => {
            const successRate = channel.success_count + channel.failure_count > 0 ?
                Math.round(channel.success_count / (channel.success_count + channel.failure_count) * 100) : 0;
            
            const lastProcessed = channel.last_processed ? 
                new Date(channel.last_processed).toLocaleDateString('ru-RU') : 'Никогда';
            
            const lastSuccess = channel.last_success ?
                new Date(channel.last_success).toLocaleDateString('ru-RU') : 'Никогда';
            
            html += `
                <tr class="${channel.is_active ? '' : 'table-secondary'}">
                    <td>
                        <span class="badge bg-${getSourceColor(channel.source)}">
                            ${channel.source}
                        </span>
                    </td>
                    <td>
                        <div><strong>${channel.channel_id || 'N/A'}</strong></div>
                        <small class="text-muted" style="font-size: 0.8em;">
                            <a href="${channel.url}" target="_blank">${truncateUrl(channel.url)}</a>
                        </small>
                    </td>
                    <td>
                        <span class="badge bg-info">${channel.news_collected || 0}</span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${getScoreColor(channel.avg_interest_score)}" 
                                 style="width: ${Math.min(channel.avg_interest_score * 100, 100)}%">
                                ${(channel.avg_interest_score || 0).toFixed(4)}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${getSuccessColor(successRate)}" 
                                 style="width: ${successRate}%">
                                ${successRate}%
                            </div>
                        </div>
                        <small>${channel.success_count}/${channel.success_count + channel.failure_count}</small>
                    </td>
                    <td>
                        <div><small>Обработка: ${lastProcessed}</small></div>
                        <div><small>Успех: ${lastSuccess}</small></div>
                    </td>
                    <td>
                        ${channel.is_active ? 
                            '<span class="badge bg-success">Активен</span>' : 
                            '<span class="badge bg-danger">Неактивен</span>'}
                        ${channel.deactivation_reason ? 
                            `<br><small class="text-danger">${channel.deactivation_reason}</small>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="toggleChannel('${channel.channel_id}', '${channel.source}', ${channel.is_active})"
                                title="${channel.is_active ? 'Деактивировать' : 'Активировать'}">
                            <i class="bi bi-power"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" 
                                onclick="processChannel('${channel.channel_id}', '${channel.source}')"
                                title="Обработать сейчас">
                            <i class="bi bi-play"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    } else {
        html = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    Нет каналов, соответствующих фильтрам
                </td>
            </tr>
        `;
    }
    
    $('#channels-table tbody').html(html);
}

function getSourceColor(source) {
    switch(source) {
        case 'telegram': return 'primary';
        case 'youtube': return 'danger';
        case 'twitter': return 'info';
        case 'reddit': return 'warning';
        default: return 'secondary';
    }
}

function getScoreColor(score) {
    if (score >= 0.5) return 'bg-success';
    if (score >= 0.3) return 'bg-warning';
    return 'bg-danger';
}

function getSuccessColor(rate) {
    if (rate >= 80) return 'bg-success';
    if (rate >= 50) return 'bg-warning';
    return 'bg-danger';
}

function truncateUrl(url, maxLength = 40) {
    if (url.length <= maxLength) return url;
    return url.substring(0, maxLength - 3) + '...';
}

function toggleChannel(channelId, sourceType, isActive) {
    const action = isActive ? 'деактивировать' : 'активировать';
    if (confirm(`${action} канал ${channelId}?`)) {
        alert('Функционал активации/деактивации каналов будет реализован в следующей версии');
        // В реальном приложении здесь был бы API вызов
        // loadChannels(); // Перезагрузить список
    }
}

function processChannel(channelId, sourceType) {
    if (confirm(`Обработать канал ${channelId} сейчас?`)) {
        alert('Функционал принудительной обработки каналов будет реализован в следующей версии');
        // В реальном приложении здесь был бы API вызов
    }
}
</script>
{% endblock %}